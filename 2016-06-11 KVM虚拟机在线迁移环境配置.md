---
layout: post
title:  "KVM虚拟机在线迁移环境配置"
date:   2016-06-11 16:18:36 +0400
categories: 环境配置
tags: VM_Live_Migration
description: 基于CentOS7.0配置KVM虚拟机在线迁移的环境配置方法以及可能出现的一些问题。
---

简要配置步骤：
-------
 1. 在两台服务器上安装CentOS7的系统。
 2. 编译使用4.3.0版本内核，注意配置KVM以及虚拟设备驱动等模块。
 3. 实现两台主机无密码ssh登录，
     > 1)运行：ssh-keygen -t rsa ;
     > 2)然后拍两下回车（均选择默认） ;
     > 3)运行：ssh-copy-id -i /root/.ssh/id_rsa.pub root@target_host;
     > 4)再输入163机器上的root密码。

 4. 关闭源与目标主机的防火墙（否则出现错误“Unable to migrate guest: unable to connect to
    server at 'target_addr:49152': No route to host”）。
 5. 确保两台主机libvirtd都在运行。
 6. 源主机端打开virt-manager，Add Connection，添加对目标主机的链接。
 7. 在源主机创建虚拟机，并在目标主机相同的路径创建大于等于源虚拟机大小，相同格式相同名称的镜像文件（否则出现error：Unable to
    migrate guest: Cannot access storage file '/home/images/vm01.qcow2'
    (as uid:107, gid:107): No such file or directory）。
 8. 可以使用virt-manage进行libvirtd、tcp在线迁移，如命令：virsh migrate --live --copy-storage-all vmname qemu+ssh(or tcp)://dest_ip/system

可能出现的错误或者问题及其解决方法：
------------------

执行迁移命令的时候
1、出现错误：“error: internal error: unable to execute QEMU command 'migrate': this feature or command is not currently supported”。

通过查询(Re: [libvirt-users] Libvirt Live Migration  https://www.redhat.com/archives/libvirt-users/2014-December/msg00008.html)说是qemu-kvm版本的问题，使用的是qemu-kvm-1.5.3。网上提出问题的人说他使用qemu-kvm-1.0的可以。解决方法：推荐使用qemu-kvm-rhev 代替 qemu-kvm。

2、 出现错误：“Unable to migrate guest: internal error: process exited while connecting to monitor: Could not access KVM kernel module: Permission denied failed to initialize KVM: Permission denied“

解决方法：修改/etc/libvirt/qemu.conf，使user=root，group=root，dynamic_ownership = 0然后重启服务libvirtd。

3、出现错误：“Could not access KVM kernel module: Permission denied failed to initialize KVM :  Permission denied

解决方法：rmmod kvm_intel; rmmod kvm; modprobe kvm; modprobe kvm_intel

4、出现错误：“Error starting domain: internal error: process exited while connecting to monitor: qemu-system-x86_64:  …… Can't use 'raw' as a block driver for the protocol level”

解决方法： 删除CD-ROM模块。
